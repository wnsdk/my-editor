class t{constructor(){this.eventHandlers={}}on(t,e){return this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e),()=>this.off(t,e)}once(t,e){const i=o=>{this.off(t,i),e(o)};return this.on(t,i)}off(t,e){this.eventHandlers[t]&&(this.eventHandlers[t]=this.eventHandlers[t].filter(t=>t!==e))}emit(t,e){this.eventHandlers[t]&&[...this.eventHandlers[t]].forEach(i=>{try{i(e)}catch(e){console.error(`Error in event handler for "${t}":`,e)}})}offAll(t){t&&delete this.eventHandlers[t]}clear(){this.eventHandlers={}}listenerCount(t){return this.eventHandlers[t]?.length??0}eventNames(){return Object.keys(this.eventHandlers)}}class e{constructor(t=100){this.historyStack=[],this.currentIndex=-1,this.limit=t}push(t){const e=JSON.stringify(t);this.currentIndex>=0&&this.historyStack[this.currentIndex]===e||(this.historyStack=this.historyStack.slice(0,this.currentIndex+1),this.historyStack.push(e),this.currentIndex++,this.historyStack.length>this.limit&&(this.historyStack.shift(),this.currentIndex--))}canUndo(){return this.currentIndex>0}canRedo(){return this.currentIndex<this.historyStack.length-1}undo(){if(!this.canUndo())return null;this.currentIndex--;const t=this.historyStack[this.currentIndex];return t?JSON.parse(t):null}redo(){if(!this.canRedo())return null;this.currentIndex++;const t=this.historyStack[this.currentIndex];return t?JSON.parse(t):null}clear(){this.historyStack=[],this.currentIndex=-1}getState(){return{canUndo:this.canUndo(),canRedo:this.canRedo(),stackSize:this.historyStack.length,currentIndex:this.currentIndex}}}const i="blockId";function o(t){if(!t)return null;let e=t.nodeType===Node.ELEMENT_NODE?t:t.parentElement;for(;e;){if(e.dataset&&e.dataset[i])return e;e=e.parentElement}return null}function s(t,e){t.dataset[i]=e}class n{constructor(t){this.savedRange=null,this.savedCaretClientX=null,this.savedCaretClientY=null,this.editor=t}getNativeSelection(){return window.getSelection()}getCurrentBlock(){const t=this.getNativeSelection();if(!t||0===t.rangeCount)return null;const e=t.anchorNode;if(!e)return null;const i=o(e);if(!i)return null;const s=i.dataset.blockId;return s?this.editor.blocks.find(t=>t.id===s)??null:null}saveCaretPosition(){const t=this.getNativeSelection();if(t&&t.rangeCount>0){this.savedRange=t.getRangeAt(0).cloneRange();const e=this.savedRange.getBoundingClientRect();this.savedCaretClientX=e.left+e.width/2,this.savedCaretClientY=e.top+e.height/2}else this.savedRange=null,this.savedCaretClientX=null,this.savedCaretClientY=null}restoreCaretPosition(t){if(this.savedRange&&t.contains(this.savedRange.startContainer)&&t.contains(this.savedRange.endContainer)){const t=this.getNativeSelection();return!!t&&(t.removeAllRanges(),t.addRange(this.savedRange),!0)}return!1}setRangeAtStart(t){const e=document.createRange();e.selectNodeContents(t),e.collapse(!0);const i=this.getNativeSelection();i?.removeAllRanges(),i?.addRange(e)}setRangeAtEnd(t){const e=document.createRange();e.selectNodeContents(t),e.collapse(!1);const i=this.getNativeSelection();i?.removeAllRanges(),i?.addRange(e)}setRangeAtNearestPoint(t,e,i){if(!t)return!1;const o=this.getNativeSelection();if(!o)return!1;o.removeAllRanges();let s=null;if(document.caretPositionFromPoint){const o=document.caretPositionFromPoint(e,i);o&&t.contains(o.offsetNode)&&(s=document.createRange(),s.setStart(o.offsetNode,o.offset),s.collapse(!0))}else if(document.caretRangeFromPoint){const o=document.caretRangeFromPoint(e,i);o&&t.contains(o.startContainer)&&(s=o)}return s?(o.addRange(s),!0):(this.setRangeAtStart(t),!1)}setRange(t,e){const i=window.getSelection();if(!i)return;const o=document.createRange();let s=0,n=!1;function r(t){if(t.nodeType===Node.TEXT_NODE){const i=t.textContent?.length??0;if(s+i>=e)return o.setStart(t,e-s),o.collapse(!0),n=!0,!0;s+=i}else if(t.nodeType===Node.ELEMENT_NODE)for(const e of Array.from(t.childNodes))if(r(e))return!0;return!1}for(const e of Array.from(t.childNodes))if(r(e))break;n||this.setRangeAtEnd(t),i.removeAllRanges(),i.addRange(o)}}class r{constructor(t){this.selectedBlockIds=new Set,this.rangeSelection=null,this.selectionType="collapsed",this.anchorBlock=null,this.anchorOffset=0,this.editor=t}getSelectionType(){return this.selectionType}getSelectedBlockIds(){return Array.from(this.selectedBlockIds)}getSelectedBlocks(){return this.editor.blocks.filter(t=>this.selectedBlockIds.has(t.id))}getRangeSelection(){return this.rangeSelection}hasSelection(){return"collapsed"!==this.selectionType&&(this.selectedBlockIds.size>0||null!==this.rangeSelection)}selectBlock(t,e=!1){e||this.clearSelection(),this.selectionType="block",this.selectedBlockIds.add(t.id),this._updateBlockSelectionUI()}toggleBlockSelection(t){this.selectionType="block",this.selectedBlockIds.has(t.id)?this.selectedBlockIds.delete(t.id):this.selectedBlockIds.add(t.id),0===this.selectedBlockIds.size&&(this.selectionType="collapsed"),this._updateBlockSelectionUI()}selectBlockRange(t,e){const i=this.editor.blocks,o=i.indexOf(t),s=i.indexOf(e);if(-1===o||-1===s)return;const n=Math.min(o,s),r=Math.max(o,s);this.clearSelection(),this.selectionType="block";for(let t=n;t<=r;t++){const e=i[t];e&&this.selectedBlockIds.add(e.id)}this._updateBlockSelectionUI()}startRangeSelection(t,e=0){this.anchorBlock=t,this.anchorOffset=e,this.selectionType="range"}extendRangeSelection(t,e=0){if(!this.anchorBlock)return void this.startRangeSelection(t,e);const i=this.editor.blocks,o=i.indexOf(this.anchorBlock),s=i.indexOf(t);if(-1===o||-1===s)return;let n,r,l,c;o<s||o===s&&this.anchorOffset<=e?(n=this.anchorBlock,r=this.anchorOffset,l=t,c=e):(n=t,r=e,l=this.anchorBlock,c=this.anchorOffset),this.rangeSelection={startBlock:n,startOffset:r,endBlock:l,endOffset:c},this.selectedBlockIds.clear();const a=i.indexOf(n),d=i.indexOf(l);for(let t=a;t<=d;t++){const e=i[t];e&&this.selectedBlockIds.add(e.id)}this._updateRangeSelectionUI()}selectAll(){this.clearSelection(),this.selectionType="block",this.editor.blocks.forEach(t=>{this.selectedBlockIds.add(t.id)}),this._updateBlockSelectionUI()}clearSelection(){this.selectedBlockIds.clear(),this.rangeSelection=null,this.anchorBlock=null,this.anchorOffset=0,this.selectionType="collapsed",this._clearSelectionUI()}deleteSelectedBlocks(){if(0===this.selectedBlockIds.size)return;this.getSelectedBlocks().forEach(t=>{const e=this.editor.blocks.indexOf(t);-1!==e&&this.editor.blocks.splice(e,1)}),this.clearSelection(),this.editor.handleEmptyEditorState(),this.editor.renderer.render(this.editor.blocks),this.editor.saveHistory(),this.editor.eventBus.emit("document:mutated")}serializeSelection(){return"block"===this.selectionType?this.getSelectedBlocks().map(t=>t.toJSON()):"range"===this.selectionType&&this.rangeSelection?this._serializeRangeSelection():[]}_serializeRangeSelection(){if(!this.rangeSelection)return[];const{startBlock:t,startOffset:e,endBlock:i,endOffset:o}=this.rangeSelection,s=this.editor.blocks,n=s.indexOf(t),r=s.indexOf(i),l=[];for(let t=n;t<=r;t++){const i=s[t];if(!i)continue;const c=i.toJSON();if(t===n&&t===r){if("text"===i.type&&"html"in c){const t=c.html||"";c.html=this._extractTextRange(t,e,o)}}else if(t===n){if("text"===i.type&&"html"in c){const t=c.html||"";c.html=this._extractTextRange(t,e,t.length)}}else if(t===r&&"text"===i.type&&"html"in c){const t=c.html||"";c.html=this._extractTextRange(t,0,o)}l.push(c)}return l}_extractTextRange(t,e,i){const o=document.createElement("div");o.innerHTML=t;return(o.textContent||"").substring(e,i)}_updateBlockSelectionUI(){this.editor.blocks.forEach(t=>{t.el&&(this.selectedBlockIds.has(t.id)?t.el.classList.add("multi-selected"):t.el.classList.remove("multi-selected"))})}_updateRangeSelectionUI(){this.editor.blocks.forEach(t=>{t.el&&(this.selectedBlockIds.has(t.id)?t.el.classList.add("range-selected"):t.el.classList.remove("range-selected"))}),this._applyNativeRangeSelection()}_applyNativeRangeSelection(){if(!this.rangeSelection)return;const{startBlock:t,startOffset:e,endBlock:i,endOffset:o}=this.rangeSelection,s=window.getSelection();if(s){s.removeAllRanges();try{const n=document.createRange(),r=this._getTextNodeAtOffset(t.el,e);r.node?n.setStart(r.node,r.offset):t.el&&n.setStart(t.el,0);const l=this._getTextNodeAtOffset(i.el,o);l.node?n.setEnd(l.node,l.offset):i.el&&n.setEndAfter(i.el),s.addRange(n)}catch(t){console.warn("Failed to apply native range selection:",t)}}}_getTextNodeAtOffset(t,e){if(!t)return{node:null,offset:0};let i=0;const o=function t(o){if(o.nodeType===Node.TEXT_NODE){const t=o.textContent?.length??0;if(i+t>=e)return{node:o,offset:e-i};i+=t}else if(o.nodeType===Node.ELEMENT_NODE)for(const e of Array.from(o.childNodes)){const i=t(e);if(i)return i}return null}(t);return o||{node:t,offset:0}}_clearSelectionUI(){this.editor.blocks.forEach(t=>{t.el&&t.el.classList.remove("multi-selected","range-selected")})}destroy(){this.clearSelection()}}class l{constructor(t){this.editor=t}render(t){const e=new Set(t.map(t=>t.id)),i=Array.from(this.editor.root.children).filter(t=>t instanceof HTMLElement&&t.classList.contains("block"));this._removeDeletedBlocks(i,e),this._addOrReorderBlocks(t)}_removeDeletedBlocks(t,e){t.forEach(t=>{const i=t.dataset.blockId;i&&!e.has(i)&&(this.editor.root.removeChild(t),this.editor.eventBus.emit("block:removed",i))})}_addOrReorderBlocks(t){t.forEach((e,i)=>{const o=this.editor.root.querySelector(`[data-block-id="${e.id}"]`),s=t[i+1],n=s?this.editor.root.querySelector(`[data-block-id="${s.id}"]`):null;if(!o)return e.mount(this.editor.root,n??void 0),void this.editor.eventBus.emit("block:added",e.id);const r=t[i-1],l=r?r.id:null;let c=o.previousElementSibling;for(;c&&!c.classList.contains("block");)c=c.previousElementSibling;l!==(c instanceof HTMLElement?c.dataset.blockId??null:null)&&this.editor.root.insertBefore(o,n)})}}const c={};function a(t,e){c[t]&&console.warn(`Block type "${t}" is already registered. Overwriting.`),c[t]=e}function d(t,e={},i){const o=c[t];if(!o)throw new Error(`BlockFactory: Unknown block type "${t}". Please ensure it is registered.`);return new o(e,i)}function h(t,e){if(!t||!t.type)throw new Error("BlockFactory: Invalid JSON data for block creation. 'type' property is missing.");const i=c[t.type];if(!i)throw new Error(`BlockFactory: Unknown block type "${t.type}" from JSON. Please ensure it is registered.`);return new i(t,e)}var u=Object.freeze({__proto__:null,createBlock:d,createBlockFromJSON:h,createDefaultBlocks:function(t){return[d("text","",t)]},registerBlock:a});class g{constructor(t){this.editor=t}static getToolSettings(){return{}}}class f{constructor(t,e=0){this.el=null,this.type=t,this.id=crypto.randomUUID(),this.depth=e}mount(t,e){this.el?(s(this.el,this.id),e?t.insertBefore(this.el,e):t.appendChild(this.el)):console.warn(`Block type ${this.type} has no element to mount.`)}isEmpty(){return!this.el||""===this.el.textContent.trim()}focus(t){this.el&&("text"!==this.type&&this.el.focus({preventScroll:!0}),this.el.scrollIntoView({behavior:"smooth",block:"nearest"}))}}class p extends f{constructor(t,e=0){super(t,e)}createWrapper(t){const e=document.createElement("div");e.className=`block ${this.type}-block-wrapper`,e.contentEditable="false",e.draggable=!0;const i=document.createElement("div");return i.className=`${this.type}-block`,t&&i.classList.add(`align-${t}`),e.appendChild(i),this.el=e,{wrapper:e,content:i}}createPlaceholder(t){const e=document.createElement("div");return e.className=`${this.type}-placeholder`,e.textContent=t,e}appendDeleteButton(t){if(!this.config.showDeleteButton)return;const e=function(){const t=document.createElement("button");return t.classList.add("delete-media-btn"),t.innerHTML='\n    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path fill-rule="evenodd" clip-rule="evenodd" d="M10.6056 12L3 4.39436L4.39436 3L12 10.6056L19.6056 3L21 4.39436L13.3944 12L21 19.6056L19.6056 21L12 13.3944L4.39436 21L3 19.6056L10.6056 12Z" fill="#fff"/>\n    </svg>\n',t}();e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.api.removeBlock(this)}),t.appendChild(e)}}class m extends p{static createDefault(t,e){return new m({type:"image",src:t,alt:"",width:null,height:null,align:"center"},e)}static create(t,e){return new m(t,e)}constructor(t,e){super("image",t.depth||0),this.config=e.config,this.api=e.api,this.data={type:"image",src:t.src??"",alt:t.alt??"",width:t.width??null,height:t.height??null,align:t.align??"center"};const{content:i}=this.createWrapper(this.data.align);this.renderContent(i)}getMediaSrc(){return this.data.src}renderContent(t){if(t.innerHTML="",this.data.src)this._renderImageElement(t);else{const e=this.createPlaceholder("No Image Selected");t.appendChild(e)}}_renderImageElement(t){const e=document.createElement("img");e.src=this.data.src,null!=this.data.alt&&(e.alt=this.data.alt),null!==this.data.width&&void 0!==this.data.width&&(e.style.width="number"==typeof this.data.width?`${this.data.width}px`:this.data.width),null!==this.data.height&&void 0!==this.data.height&&(e.style.height="number"==typeof this.data.height?`${this.data.height}px`:this.data.height),t.appendChild(e),this.appendDeleteButton(t)}toJSON(){return{id:this.id,...this.data,depth:this.depth}}}class k extends g{constructor(t){super(t),this.toolbarEl=null,this.currentBlock=null,this.currentMediaEl=null,this.onRootClick=t=>{const e=t.target.closest(".image-block img, .video-block video");if(!e)return void(this.toolbarEl&&!this.toolbarEl.contains(t.target)&&this.hideToolbar());const i=o(e);if(!i)return;const s=i.dataset.blockId,n=this.editor.blocks.find(t=>t.id===s);if(!n)return;const r=this.editor.getToolConfig(n.type);!1!==r?.toolbar?this.showToolbar(e,n):this.hideToolbar()},this.hideToolbar=()=>{this.toolbarEl&&(this.toolbarEl.classList.add("hidden"),this.currentBlock=null,this.currentMediaEl=null)},this.onToolbarClick=t=>{t.preventDefault();const e=t.target.closest("[data-action]");if(!e||!this.currentBlock)return;const i=e.getAttribute("data-action");if("remove"===i)return this.editor.removeBlock(this.currentBlock),void this.hideToolbar();this.currentMediaEl&&(this.currentMediaEl.style.display="block",this.currentMediaEl.style.margin="0 auto","left"===i&&(this.currentMediaEl.style.marginLeft="0",this.currentMediaEl.style.marginRight="auto"),"right"===i&&(this.currentMediaEl.style.marginLeft="auto",this.currentMediaEl.style.marginRight="0"))}}initialize(){a("image",m),this.toolbarEl||(this.toolbarEl=this.createToolbarElement(),document.body.appendChild(this.toolbarEl),this.toolbarEl.addEventListener("click",this.onToolbarClick)),this.editor.root.addEventListener("click",this.onRootClick),document.addEventListener("scroll",this.hideToolbar,{passive:!0})}destroy(){this.editor.root.removeEventListener("click",this.onRootClick),document.removeEventListener("scroll",this.hideToolbar),this.toolbarEl?.remove()}createToolbarElement(){const t=document.createElement("div");return t.className="editor-image-toolbar hidden",t.innerHTML='\n            <button data-action="left">왼쪽</button>\n            <button data-action="center">가운데</button>\n            <button data-action="right">오른쪽</button>\n            <button data-action="remove">삭제</button>\n        ',t}showToolbar(t,e){const i=this.editor.getToolConfig(e.type);if(!1===i?.toolbar)return;this.toolbarEl||(this.toolbarEl=this.createToolbarElement(),document.body.appendChild(this.toolbarEl),this.toolbarEl.addEventListener("click",this.onToolbarClick)),this.currentBlock=e,this.currentMediaEl=t;const o=t.getBoundingClientRect(),s=this.toolbarEl.getBoundingClientRect(),n=o.top-s.height-10+window.scrollY,r=o.left+o.width/2-s.width/2+window.scrollX;this.toolbarEl.style.top=`${n}px`,this.toolbarEl.style.left=`${r}px`,this.toolbarEl.classList.remove("hidden")}static getToolSettings(){return{image:{maxCount:5,toolbar:!0,onMaxCountReached:t=>{alert(`이미지 블록은 최대 ${t}개까지 등록할 수 있습니다.`)},config:{showDeleteButton:!0,uploader:{fileSelectButton:"image-tool-button",uploadByFile:async t=>({url:URL.createObjectURL(t)})}}}}}}class b extends f{constructor(t,e=0){super(t,e)}createEditableElement(t="div",e){const i=document.createElement(t);return i.className=e,this.api.editor.readOnly||(i.contentEditable="true"),i.setAttribute("spellcheck","false"),i}setHtmlContent(t,e){t.innerHTML=""===e?"<br>":e}isEmpty(){return!this.el||("<br>"===this.el.innerHTML||0===this.el.textContent?.trim().length)}focus(t){if(!this.el)return;super.focus(t);const e=this.api.editor.selection;if(!e)return void this.el.focus({preventScroll:!0});const i=window.getSelection();i&&!i.isCollapsed||this.handleCaretPositioning(t,e)}handleCaretPositioning(t,e){if(t&&t instanceof MouseEvent&&"click"===t.type&&document.caretRangeFromPoint&&t.clientX&&t.clientY){const e=document.caretRangeFromPoint(t.clientX,t.clientY);if(e&&this.el.contains(e.startContainer)){const t=window.getSelection();return t?.removeAllRanges(),void t?.addRange(e)}}}}class y extends b{static createDefault(t){return new y("",t)}static create(t,e){return new y(t,e)}constructor(t="",e){super("text","object"==typeof t&&t.depth?t.depth:0),this.config=e.config,this.api=e.api;let i="";"string"==typeof t?i=t:t&&"object"==typeof t&&(i=t.html||""),this.el=this.createEditableElement("div","block text-block"),this.setHtmlContent(this.el,i)}getHtmlContent(){return this.el.innerHTML}toJSON(){return{id:this.id,type:"text",html:this.el.innerHTML,depth:this.depth}}}class v extends g{constructor(t){super(t)}initialize(){a("text",y)}static getToolSettings(){return{text:{toolbar:!0,config:{}}}}}function E(t){return"list"===t.type&&"refreshListContent"in t}class C extends b{constructor(t,e){super("list",t.depth||0),this.config=e.config,this.api=e.api,this.style=t.style||"unordered",this.html=t.html||""}render(){const t=document.createElement("div");t.classList.add("block","list-block",`list-${this.style}`),t.dataset.type="list";const e=document.createElement("div");e.classList.add("list-item-row"),e.style.display="flex";const i=document.createElement("span");i.classList.add("list-bullet"),i.style.marginRight="8px",i.style.userSelect="none",i.contentEditable="false";const o=this.createEditableElement("div","list-item-content");return this.setHtmlContent(o,this.html),o.style.flex="1",e.appendChild(i),e.appendChild(o),t.appendChild(e),this.el=t,this._updateBullet(),t}mount(t,e){this.el||this.render(),super.mount(t,e)}handleCaretPositioning(t,e){if(t&&t instanceof MouseEvent&&"click"===t.type)return;const i=this.el.querySelector(".list-item-content");i instanceof HTMLElement&&this.api.editor.selection.setRangeAtStart(i)}getHtmlContent(){return this.html}refreshListContent(){this._updateBullet()}_updateBullet(){if(!this.el)return;const t=this.el.querySelector(".list-bullet");if(t)if("ordered"===this.style){const e=this._calculateStartIndex();t.textContent=`${e}.`}else t.textContent="•"}_calculateStartIndex(){const t=this.api.editor,e=t.blocks.indexOf(this);let i=1;for(let o=e-1;o>=0;o--){const e=t.blocks[o];if(!e||!E(e)||"ordered"!==e.style)break;i++}return e-(e-(i-1))+1}toJSON(){if(this.el){const t=this.el.querySelector(".list-item-content");t&&(this.html=t.innerHTML)}return{id:this.id,type:"list",style:this.style,html:this.html,depth:this.depth}}}class B extends g{constructor(t){super(t)}initialize(){a("list",C),this.editor.root.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){if(" "!==t.key)return;const e=this.editor.selection.getCurrentBlock();if(!e||"text"!==e.type)return;const i=e.el;if(!i)return;const o=i.textContent||"",s=window.getSelection();if(!s||s.anchorOffset>2)return;let n=null;if("*"===o||"-"===o?n="unordered":"1."===o&&(n="ordered"),n){t.preventDefault(),this.editor.saveHistory();const i=new C({type:"list",style:n,html:""},{config:{},api:{removeBlock:t=>this.editor.removeBlock(t),editor:this.editor}}),o=this.editor.blocks.indexOf(e);this.editor.blocks.splice(o,1,i),this.editor.renderer.render(this.editor.blocks),i.focus(),this.editor.saveHistory()}}static getToolSettings(){return{list:{toolbar:!0,config:{}}}}}class S extends p{static createDefault(t,e){return new S({type:"video",src:t},e)}static create(t,e){return new S(t,e)}constructor(t="",e){super("video","object"==typeof t&&t.depth?t.depth:0),this.config=e.config,this.api=e.api,this.data={type:"video",src:"string"==typeof t?t:t.src??"",posterUrl:"string"==typeof t?void 0:t.posterUrl};const{content:i}=this.createWrapper();this.renderContent(i)}getMediaSrc(){return this.data.src}renderContent(t){if(t.innerHTML="",this.data.src)this._renderVideoElement(t);else{const e=this.createPlaceholder("No Video Selected");t.appendChild(e)}}_renderVideoElement(t){const e=document.createElement("video");e.controls=!0,this.data.posterUrl&&(e.poster=this.data.posterUrl);const i=document.createElement("source");i.src=this.data.src,e.appendChild(i),e.insertAdjacentText("beforeend","Your browser does not support the video tag."),t.appendChild(e),this.appendDeleteButton(t)}toJSON(){return{id:this.id,type:"video",src:this.data.src,posterUrl:this.data.posterUrl,depth:this.depth}}}class x extends g{constructor(t){super(t)}initialize(){a("video",S)}static getToolSettings(){return{video:{maxCount:3,onMaxCountReached:t=>{alert(`비디오 블록은 최대 ${t}개까지 등록할 수 있습니다.`)},toolbar:!1,config:{showDeleteButton:!0,uploader:{fileSelectButton:"video-tool-button",uploadByFile:async t=>({url:URL.createObjectURL(t)})}}}}}}class w extends f{static createDefault(t){return new w({},t)}static create(t,e){return new w(t,e)}constructor(t,e){super("table",t.depth||0),this.tableEl=null,this.isResizing=!1,this.resizingColIndex=-1,this.startX=0,this.startWidth=0,this._onCellInput=t=>{const e=t.target;if(!e.classList.contains("table-cell-content"))return;const i=e.closest("td");if(!i)return;const o=parseInt(i.dataset.row||"0",10),s=parseInt(i.dataset.col||"0",10);this.rows[o]&&this.rows[o][s]&&(this.rows[o][s].html=e.innerHTML)},this._onKeyDown=t=>{const e=t.target;if(!e.classList.contains("table-cell-content"))return;const i=e.closest("td");if(!i)return;const o=parseInt(i.dataset.row||"0",10),s=parseInt(i.dataset.col||"0",10);let n=o,r=s,l=!1;const c=this.rows[0]?.length||0,a=window.getSelection(),d=a?.rangeCount?a.getRangeAt(0):null;switch(t.key){case"ArrowUp":o>0&&(n=o-1,l=!0);break;case"ArrowDown":o<this.rows.length-1&&(n=o+1,l=!0);break;case"ArrowLeft":const i=this._isCursorAtStart(e,d);if(i&&s>0)r=s-1,l=!0;else if(!i)return;break;case"ArrowRight":const a=this._isCursorAtEnd(e,d);if(a&&s<c-1)r=s+1,l=!0;else if(!a)return;break;case"Tab":t.preventDefault(),s<c-1?r=s+1:o<this.rows.length-1&&(n=o+1,r=0),l=!0}!l||n===o&&r===s||(t.preventDefault(),this._moveFocusToCell(n,r))},this._onToolbarClick=t=>{const e=t.target.dataset.action;if(e)switch(t.preventDefault(),t.stopPropagation(),e){case"add-row":this.addRow();break;case"add-col":this.addColumn();break;case"delete-row":this.deleteRow();break;case"delete-col":this.deleteColumn();break;case"delete-table":this.api.removeBlock(this)}},this._onResizeStart=t=>{const e=t.target;e.classList.contains("col-resize-handle")&&(t.preventDefault(),this.isResizing=!0,this.resizingColIndex=parseInt(e.dataset.colIndex||"0",10),this.startX=t.clientX,this.startWidth=this.colWidths[this.resizingColIndex]??100,document.body.style.cursor="col-resize",document.body.style.userSelect="none")},this._onResizeMove=t=>{if(!this.isResizing)return;const e=t.clientX-this.startX,i=this.config.minCellWidth||50,o=Math.max(i,this.startWidth+e);this.colWidths[this.resizingColIndex]=o,this._updateColumnWidth(this.resizingColIndex,o)},this._onResizeEnd=()=>{this.isResizing&&(this.isResizing=!1,this.resizingColIndex=-1,document.body.style.cursor="",document.body.style.userSelect="",this.api.editor.saveHistory())},this.config=e.config,this.api=e.api;const i=this.config.defaultRows||2,o=this.config.defaultCols||2;t.rows&&t.rows.length>0?this.rows=t.rows:this.rows=this._createEmptyRows(i,o);const s=this.rows[0]?.length||o;this.colWidths=t.colWidths||Array(s).fill(120),this._render(),this._bindEvents()}_createEmptyRows(t,e){const i=[];for(let o=0;o<t;o++){const t=[];for(let i=0;i<e;i++)t.push({html:""});i.push(t)}return i}_render(){this.el=document.createElement("div"),this.el.className="block table-block-wrapper",this.el.contentEditable="false";const t=document.createElement("div");t.className="table-container",this.tableEl=document.createElement("table"),this.tableEl.className="table-block";const e=document.createElement("colgroup");this.colWidths.forEach(t=>{const i=document.createElement("col");i.style.width=`${t}px`,e.appendChild(i)}),this.tableEl.appendChild(e);const i=document.createElement("tbody");this.rows.forEach((t,e)=>{const o=document.createElement("tr");t.forEach((i,s)=>{const n=document.createElement("td");n.dataset.row=String(e),n.dataset.col=String(s);const r=document.createElement("div");if(r.className="table-cell-content",this.api.editor.readOnly||(r.contentEditable="true"),r.innerHTML=i.html||"<br>",n.appendChild(r),s<t.length-1&&!this.api.editor.readOnly){const t=document.createElement("div");t.className="col-resize-handle",t.dataset.colIndex=String(s),n.appendChild(t)}o.appendChild(n)}),i.appendChild(o)}),this.tableEl.appendChild(i),t.appendChild(this.tableEl),this.el.appendChild(t),this.api.editor.readOnly||this._renderToolbar()}_renderToolbar(){if(!this.el)return;const t=document.createElement("div");t.className="table-toolbar",t.innerHTML='\n            <button data-action="add-row" title="행 추가">+ 행</button>\n            <button data-action="add-col" title="열 추가">+ 열</button>\n            <button data-action="delete-row" title="행 삭제">- 행</button>\n            <button data-action="delete-col" title="열 삭제">- 열</button>\n            <button data-action="delete-table" title="테이블 삭제">삭제</button>\n        ',t.addEventListener("click",this._onToolbarClick),this.el.appendChild(t)}_bindEvents(){this.el&&(this.el.addEventListener("input",this._onCellInput),this.el.addEventListener("keydown",this._onKeyDown),this.el.addEventListener("mousedown",this._onResizeStart),document.addEventListener("mousemove",this._onResizeMove),document.addEventListener("mouseup",this._onResizeEnd))}_unbindEvents(){document.removeEventListener("mousemove",this._onResizeMove),document.removeEventListener("mouseup",this._onResizeEnd)}_isCursorAtStart(t,e){if(!e||!e.collapsed)return!1;const i=this._getFirstTextNode(t);return e.startContainer===i&&0===e.startOffset}_isCursorAtEnd(t,e){if(!e||!e.collapsed)return!1;const i=this._getLastTextNode(t);return!i||e.startContainer===i&&e.startOffset===(i.textContent?.length||0)}_getFirstTextNode(t){return document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null).nextNode()}_getLastTextNode(t){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null);let i,o=null;for(;i=e.nextNode();)o=i;return o}_moveFocusToCell(t,e){if(!this.el)return;const i=this.el.querySelector(`td[data-row="${t}"][data-col="${e}"] .table-cell-content`);if(i instanceof HTMLElement){i.focus();const t=document.createRange(),e=window.getSelection();t.selectNodeContents(i),t.collapse(!0),e?.removeAllRanges(),e?.addRange(t)}}_updateColumnWidth(t,e){if(!this.tableEl)return;const i=this.tableEl.querySelector(`colgroup col:nth-child(${t+1})`);i instanceof HTMLElement&&(i.style.width=`${e}px`)}addRow(t){const e=this.rows[0]?.length||2,i=Array(e).fill(null).map(()=>({html:""})),o=void 0!==t?t:this.rows.length;this.rows.splice(o,0,i),this._refreshTable(),this.api.editor.saveHistory()}addColumn(t){const e=void 0!==t?t:this.rows[0]?.length||0;this.rows.forEach(t=>{t.splice(e,0,{html:""})}),this.colWidths.splice(e,0,120),this._refreshTable(),this.api.editor.saveHistory()}deleteRow(t){if(this.rows.length<=1)return;const e=void 0!==t?t:this.rows.length-1;this.rows.splice(e,1),this._refreshTable(),this.api.editor.saveHistory()}deleteColumn(t){if((this.rows[0]?.length||0)<=1)return;const e=void 0!==t?t:(this.rows[0]?.length||1)-1;this.rows.forEach(t=>{t.splice(e,1)}),this.colWidths.splice(e,1),this._refreshTable(),this.api.editor.saveHistory()}_refreshTable(){if(!this.el)return;const t=this.el.parentNode,e=this.el.nextSibling;this._unbindEvents(),this.el.remove(),this._render(),this._bindEvents(),t&&this.el&&(s(this.el,this.id),e?t.insertBefore(this.el,e):t.appendChild(this.el))}isEmpty(){return this.rows.every(t=>t.every(t=>!t.html||"<br>"===t.html))}focus(t){if(!this.el)return;if(t instanceof MouseEvent){const e=t.target.closest(".table-cell-content");if(e instanceof HTMLElement&&this.el.contains(e))return}const e=this.el.querySelector(".table-cell-content");if(e instanceof HTMLElement){e.focus();const t=document.createRange(),i=window.getSelection();t.selectNodeContents(e),t.collapse(!0),i?.removeAllRanges(),i?.addRange(t)}}toJSON(){if(this.el){this.el.querySelectorAll(".table-cell-content").forEach(t=>{const e=t.closest("td");if(!e)return;const i=parseInt(e.dataset.row||"0",10),o=parseInt(e.dataset.col||"0",10);this.rows[i]&&this.rows[i][o]&&(this.rows[i][o].html=t.innerHTML)})}return{id:this.id,type:"table",rows:this.rows,colWidths:this.colWidths,depth:this.depth}}}const _=new Set(["B","I","U","STRONG","EM","A","SPAN","BR","CODE"]),T=new Set(["DIV","P","UL","OL","LI","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","PRE"]),R=new Set(["href","target","rel","class","id","data-block-id","data-img-action","data-block-move"]),L=new Set(["http:","https:","mailto:","tel:"]),A=/^\s*(javascript|vbscript|data):/i;class O{static clean(t){if(!t||!t.includes("<"))return O._escapeHtml(t||"");const e=(new DOMParser).parseFromString(t,"text/html");return e&&e.body?(O._traverseAndSanitize(e.body),e.body&&e.body.innerHTML||""):""}static _traverseAndSanitize(t){if(t.nodeType===Node.ELEMENT_NODE){const e=t,i=e.tagName;if(T.has(i)){const t=e.parentNode;if(t){for(;e.firstChild;)t.insertBefore(e.firstChild,e);const i=document.createElement("br");t.insertBefore(i,e),t.removeChild(e)}return}if(!_.has(i)){const t=e.parentNode;if(t){for(;e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e)}return}O._removeUnsafeAttributes(e)}Array.from(t.childNodes).forEach(t=>O._traverseAndSanitize(t))}static _removeUnsafeAttributes(t){Array.from(t.attributes).forEach(e=>{const i=e.name.toLowerCase();if(i.startsWith("on"))t.removeAttribute(e.name);else if("style"===i)t.removeAttribute(e.name);else if("href"===i){const i=e.value;O._isValidUrl(i)||t.removeAttribute(e.name)}else if("src"===i){const i=e.value;O._isValidUrl(i)||t.removeAttribute(e.name)}else R.has(i)||t.removeAttribute(e.name)})}static _isValidUrl(t){if(!t||"string"!=typeof t)return!1;const e=t.trim();if(A.test(e))return!1;if(e.startsWith("/")||e.startsWith("./")||e.startsWith("../")||e.startsWith("#")||e.startsWith("?"))return!0;try{const t=new URL(e);return L.has(t.protocol)}catch(t){return!e.includes(":")}}static _escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}class D extends g{constructor(t){super(t)}initialize(){this.editor.root.addEventListener("keydown",this._onKeyDown.bind(this))}_onKeyDown(t){if(t.isComposing)return;if(this.editor.readOnly)return;const{key:e,ctrlKey:i,metaKey:o,shiftKey:s}=t,n=i||o;if("Escape"===e&&this.editor.multiSelection.hasSelection())return t.preventDefault(),void this.editor.multiSelection.clearSelection();if(n&&"a"===e.toLowerCase())return t.preventDefault(),void this.editor.multiSelection.selectAll();if(n&&"z"===e.toLowerCase()&&!s)return t.preventDefault(),void this.editor.undo();if(n&&"y"===e.toLowerCase()||n&&"z"===e.toLowerCase()&&s)return t.preventDefault(),void this.editor.redo();if(n&&"d"===e.toLowerCase())return t.preventDefault(),void this.editor.duplicateBlock();if(this.editor.multiSelection.hasSelection()){if("Backspace"===e||"Delete"===e)return t.preventDefault(),void this.editor.multiSelection.deleteSelectedBlocks();n||s||1!==e.length||this.editor.multiSelection.clearSelection()}const r=this.editor.selection.getCurrentBlock(),l=this.editor.getSelectedBlock();if(l&&"text"!==l.type&&("Backspace"===e||"Delete"===e)){t.preventDefault();const e=this.editor.blocks.indexOf(l);return void this._handleBlockDeletionAndFocus(l,e)}const c=r||l;c&&("Enter"!==e||s?"Backspace"===e?this._handleBackspace(t,c):"Delete"===e?this._handleDelete(t,c):["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e)&&(s?this._handleShiftArrowKeys(t,c):(this.editor.multiSelection.hasSelection()&&this.editor.multiSelection.clearSelection(),this._handleArrowKeys(t,c))):(t.preventDefault(),this._handleEnter(t,c)))}_handleEnter(t,e){if("list"===e.type)this._handleListEnter(t,e);else if("text"!==e.type){const t=this.editor.createDefaultBlock();if(!t||!t.el)return;this.editor.addBlockAfter(e,t),this.editor.selection.setRangeAtStart(t.el),this.editor.saveHistory()}else{const t=e;if(!t.el)return;const i=window.getSelection();if(!i||0===i.rangeCount)return;const o=i.getRangeAt(0),s=o.cloneRange();s.selectNodeContents(t.el),s.setStart(o.endContainer,o.endOffset);const n=s.extractContents(),r=document.createElement("div");r.appendChild(n);const l=r.innerHTML||"",c=O.clean(l),a=this.editor.getToolConfig("text"),d=y.create(c,{config:a?.config??{},api:{removeBlock:t=>this.editor.removeBlock(t),editor:this.editor}});this.editor.addBlockAfter(t,d),requestAnimationFrame(()=>{this.editor.selectAndFocusBlock(d),d.el&&this.editor.selection.setRangeAtStart(d.el)})}}_handleListEnter(t,e){const i=window.getSelection();if(!i||0===i.rangeCount)return;const o=i.getRangeAt(0),s=o.startContainer,n=s.nodeType===Node.ELEMENT_NODE?s.closest(".list-item-content"):s.parentElement?.closest(".list-item-content");if(!n)return;if(0===n.textContent?.trim().length){t.preventDefault();const i=this.editor.getToolConfig("text"),o=y.create("",{config:i?.config??{},api:{removeBlock:t=>this.editor.removeBlock(t),editor:this.editor}}),s=this.editor.blocks.indexOf(e);this.editor.blocks.splice(s,1,o),this.editor.renderer.render(this.editor.blocks),requestAnimationFrame(()=>{this.editor.selectAndFocusBlock(o),o.el&&this.editor.selection.setRangeAtStart(o.el)}),this._updateSequentialListNumbers(),this.editor.saveHistory()}else{t.preventDefault();const i=o.cloneRange();i.selectNodeContents(n),i.setStart(o.endContainer,o.endOffset);const s=i.extractContents(),r=document.createElement("div");r.appendChild(s);const l=O.clean(r.innerHTML||""),c=d("list",{type:"list",style:e.style,html:l},{config:{},api:{removeBlock:t=>this.editor.removeBlock(t),editor:this.editor}});this.editor.addBlockAfter(e,c),this._updateSequentialListNumbers(),this.editor.selectAndFocusBlock(c);const a=c.el.querySelector(".list-item-content");a&&this.editor.selection.setRangeAtStart(a),this.editor.saveHistory()}}_updateSequentialListNumbers(){this.editor.blocks.forEach(t=>{E(t)&&t.refreshListContent()})}_handleShiftArrowKeys(t,e){const i=t.key,o=this.editor.blocks.indexOf(e),s=this.editor.multiSelection,n="ArrowUp"===i,r="ArrowDown"===i,l="ArrowLeft"===i,c="ArrowRight"===i;if(!s.hasSelection()){const t=this._getCurrentCaretOffset(e);s.startRangeSelection(e,t)}if("text"!==e.type&&"list"!==e.type||!e.el){t.preventDefault();let e=o;(n||l)&&(e=o-1),(r||c)&&(e=o+1);const i=this.editor.blocks[e];i&&s.extendRangeSelection(i,0)}else{const i=window.getSelection();if(i&&i.rangeCount>0){const a=i.getRangeAt(0);if(this._isCaretAtBlockBoundary(a,e.el,n,r,l,c)){let e=o;(n||l)&&(e=o-1),(r||c)&&(e=o+1);const i=this.editor.blocks[e];if(i){t.preventDefault();const e=n||l?this._getBlockTextLength(i):0;s.extendRangeSelection(i,e)}}}}}_getCurrentCaretOffset(t){if(!t.el)return 0;const e=window.getSelection();if(!e||0===e.rangeCount)return 0;const i=e.getRangeAt(0),o=i.cloneRange();return o.selectNodeContents(t.el),o.setEnd(i.startContainer,i.startOffset),o.toString().length}_getBlockTextLength(t){return t.el&&t.el.textContent?.length||0}_handleArrowKeys(t,e){const i=t.key,o=this.editor.blocks.indexOf(e),s="ArrowUp"===i,n="ArrowDown"===i,r="ArrowLeft"===i,l="ArrowRight"===i;if("table"===e.type)return;let c=!1,a=-1;this.editor.selection.saveCaretPosition();const d=this.editor.selection.savedCaretClientX,h=this.editor.selection.savedCaretClientY;if("text"===e.type||"list"===e.type)if(e.el){const t=window.getSelection();if(t&&0!==t.rangeCount){const i=t.getRangeAt(0);this._isCaretAtBlockBoundary(i,e.el,s,n,r,l)&&(c=!0)}else c=!0}else c=!0;else c=!0;if(c){t.preventDefault(),(s||r)&&(a=o-1),(n||l)&&(a=o+1);const e=this.editor.blocks[a];if(e&&e.el&&(this.editor.selectAndFocusBlock(e),"text"===e.type))if((s||n)&&null!==d&&null!==h)this.editor.selection.setRangeAtNearestPoint(e.el,d,h);else{this.editor.selection.restoreCaretPosition(e.el)||((s||r)&&this.editor.selection.setRangeAtStart(e.el),(n||l)&&this.editor.selection.setRangeAtEnd(e.el))}}}_handleBackspace(t,e){if("text"!==e.type)return;const i=window.getSelection();if(!i||0===i.rangeCount)return;const o=i.getRangeAt(0),s=0===o.startOffset&&0===o.endOffset,n=this.editor.blocks.indexOf(e),r=this.editor.blocks[n-1]??null;if(s)if(1===this.editor.blocks.length&&e.el&&e.isEmpty())t.preventDefault();else{if(t.preventDefault(),e.el&&e.isEmpty()&&r)return this._handleBlockDeletionAndFocus(e,n,"prev"),void this.editor.saveHistory();if(r&&"text"===r.type&&e.el&&r.el){const t=e.el.innerHTML,i=r.el.textContent?.length??0;return r.el.innerHTML=r.el.innerHTML.replace(/<br>$/,"")+t,"text"in r&&(r.text=r.el.innerHTML),this.editor.removeBlock(e),this.editor.renderer.render(this.editor.blocks),this.editor.selectAndFocusBlock(r),this.editor.selection.setRange(r.el,i),void this.editor.saveHistory()}r&&"text"!==r.type&&this.editor.selectAndFocusBlock(r)}}_handleDelete(t,e){if("text"!==e.type)return;const i=window.getSelection();if(!i||0===i.rangeCount)return;const o=i.getRangeAt(0);if(!e.el)return;const s=e.el.innerText?.length??0;if(!(o.endOffset===s))return;const n=this.editor.blocks.indexOf(e),r=this.editor.blocks[n+1]??null;if(1===this.editor.blocks.length&&e.isEmpty())t.preventDefault();else{if(t.preventDefault(),e.isEmpty()&&r)return this._handleBlockDeletionAndFocus(e,n,"next"),void this.editor.saveHistory();if(r&&"text"===r.type&&r.el){const t=e.el.textContent?.length??0,i=r.el.innerHTML;return e.el.innerHTML=e.el.innerHTML.replace(/<br>$/,"")+i,"text"in e&&(e.text=e.el.innerHTML),this.editor.removeBlock(r),this.editor.renderer.render(this.editor.blocks),this.editor.selectAndFocusBlock(e),this.editor.selection.setRange(e.el,t),void this.editor.saveHistory()}r&&"text"!==r.type&&this.editor.selectAndFocusBlock(r)}}_handleBlockDeletionAndFocus(t,e,i="auto"){if(this.editor.removeBlock(t),0===this.editor.blocks.length)return void this.editor.handleEmptyEditorState();let o=null;o="prev"===i?this.editor.blocks[e-1]:"next"===i?this.editor.blocks[e]:this.editor.blocks[e]||this.editor.blocks[e-1],o&&o.el&&(this.editor.selectAndFocusBlock(o),"text"===o.type&&("prev"===i||"auto"===i?this.editor.selection.setRangeAtEnd(o.el):"next"===i&&this.editor.selection.setRangeAtStart(o.el)))}_isCaretAtBlockBoundary(t,e,i,o,s,n){const r=e.getBoundingClientRect(),l=t.getBoundingClientRect(),c=l.top-r.top<=5,a=r.bottom-l.bottom<=5,d=document.createRange();d.selectNodeContents(e);const h=0===t.compareBoundaryPoints(Range.START_TO_START,d);d.collapse(!1);const u=0===t.compareBoundaryPoints(Range.END_TO_END,d);return!(!i||!c)||(!(!o||!a)||(!(!s||!h)||!(!n||!u)))}}class I extends g{constructor(t){super(t),this.onCopyBound=this._onCopy.bind(this),this.onCutBound=this._onCut.bind(this),this.onPasteBound=this._onPaste.bind(this)}initialize(){this.editor.root.addEventListener("copy",this.onCopyBound),this.editor.root.addEventListener("cut",this.onCutBound),this.editor.root.addEventListener("paste",this.onPasteBound)}destroy(){this.editor.root.removeEventListener("copy",this.onCopyBound),this.editor.root.removeEventListener("cut",this.onCutBound),this.editor.root.removeEventListener("paste",this.onPasteBound)}_onCopy(t){this.editor.multiSelection.hasSelection()&&(t.preventDefault(),this._copySelectedContent(t.clipboardData))}_onCut(t){if(this.editor.readOnly)return;this.editor.multiSelection.hasSelection()&&(t.preventDefault(),this._copySelectedContent(t.clipboardData),this._deleteSelectedContent())}_onPaste(t){if(this.editor.readOnly)return;const e=t.clipboardData;if(!e)return void console.warn("CopyPastePlugin: No clipboard data available.");const i=e.getData(I.MIME_TYPE);if(i)return t.preventDefault(),void this._pasteBlocks(i);t.preventDefault();const o=e.getData("text/html"),s=e.getData("text/plain"),n=O.clean(o||s||"");try{this.editor.multiSelection.hasSelection()&&this._deleteSelectedContent(),document.execCommand("insertHTML",!1,n),this.editor.saveHistory()}catch(t){console.error("CopyPastePlugin: Failed to insert content:",t)}}_copySelectedContent(t){if(!t)return;const e=this.editor.multiSelection.serializeSelection();if(0===e.length)return;t.setData(I.MIME_TYPE,JSON.stringify(e));const{text:i,html:o}=this._blocksToTextAndHtml(e);t.setData("text/plain",i),t.setData("text/html",o)}_deleteSelectedContent(){const t=this.editor.multiSelection,e=t.getSelectionType();"block"===e?t.deleteSelectedBlocks():"range"===e&&this._deleteRangeSelection()}_deleteRangeSelection(){const t=this.editor.multiSelection.getRangeSelection();if(!t)return;const{startBlock:e,startOffset:i,endBlock:o,endOffset:s}=t,n=this.editor.blocks,r=n.indexOf(e),l=n.indexOf(o);if(r===l)"text"===e.type&&e.el&&this._deleteTextRange(e.el,i,s);else{if("text"===e.type&&e.el){const t=e.el.textContent||"";e.el.textContent=t.substring(0,i)}if("text"===o.type&&o.el){const t=o.el.textContent||"";o.el.textContent=t.substring(s)}if(n.slice(r+1,l).forEach(t=>{const e=this.editor.blocks.indexOf(t);-1!==e&&this.editor.blocks.splice(e,1)}),"text"===e.type&&"text"===o.type&&e.el&&o.el){e.el.textContent=(e.el.textContent||"")+(o.el.textContent||"");const t=this.editor.blocks.indexOf(o);-1!==t&&this.editor.blocks.splice(t,1)}}this.editor.multiSelection.clearSelection(),this.editor.renderer.render(this.editor.blocks),this.editor.saveHistory(),this.editor.eventBus.emit("document:mutated")}_deleteTextRange(t,e,i){const o=t.textContent||"";t.textContent=o.substring(0,e)+o.substring(i)}_blocksToTextAndHtml(t){let e="",i="";return t.forEach((t,o)=>{switch(o>0&&(e+="\n",i+="<br>"),t.type){case"text":{const o=t.html||"";e+=this._stripHtml(o),i+=o;break}case"list":{const o=t.html||"",s=t.style||"unordered";e+=this._stripHtml(o),i+="ordered"===s?`<ol>${o}</ol>`:`<ul>${o}</ul>`;break}case"image":{const o=t.src||"",s=t.alt||"";e+=`[Image: ${s||o}]`,i+=`<img src="${o}" alt="${s}">`;break}case"video":{const o=t.src||"";e+=`[Video: ${o}]`,i+=`<video src="${o}"></video>`;break}default:e+=`[${t.type}]`}}),{text:e,html:i}}_stripHtml(t){const e=document.createElement("div");return e.innerHTML=t,e.textContent||""}_pasteBlocks(t){try{const e=JSON.parse(t);if(!Array.isArray(e)||0===e.length)return;this.editor.multiSelection.hasSelection()&&this._deleteSelectedContent();const i=this.editor.selection.getCurrentBlock()||this.editor.getSelectedBlock()||this.editor.blocks[this.editor.blocks.length-1];let o=i?this.editor.blocks.indexOf(i)+1:this.editor.blocks.length;const s=e.map(t=>{const e=this.editor.toolSettings[t.type];return h(t,{config:e?.config??{},api:{removeBlock:t=>this.editor.removeBlock(t),editor:this.editor}})});s.forEach((t,e)=>{this.editor.blocks.splice(o+e,0,t)}),this.editor.renderer.render(this.editor.blocks),this.editor.saveHistory(),this.editor.eventBus.emit("document:mutated");const n=s[s.length-1];n&&requestAnimationFrame(()=>{this.editor.selectAndFocusBlock(n)})}catch(t){console.error("CopyPastePlugin: Failed to parse blocks data:",t)}}}I.MIME_TYPE="application/x-mnote-blocks";class N extends g{constructor(t){super(t)}initialize(){this.editor.root.addEventListener("click",this.onClick.bind(this))}onClick(t){const e=t.target;if(!e)return;const i=e.closest("[data-block-move='up']"),o=e.closest("[data-block-move='down']");if(!i&&!o)return;const s=e.closest("[data-block-id]"),n=s?.dataset.blockId;if(!n)return;const r=this.editor.blocks,l=r.findIndex(t=>t.id===n);if(-1===l)return;let c=null;i&&l>0?c=this._moveBlock(l,l-1):o&&l<r.length-1&&(c=this._moveBlock(l,l+1)),c&&(this.editor.renderer.render(r),this.editor.saveHistory(),this.editor.selectAndFocusBlock(c))}_moveBlock(t,e){const i=this.editor.blocks,o=i.splice(t,1)[0];return o?(i.splice(e,0,o),o):null}}class M extends g{constructor(t){super(t),this.draggingBlockEl=null,this.draggingBlockId=null,this.dragOverBlockEl=null,this.dropPosition=null,this.dragIndicatorEl=null}initialize(){this.editor.root.addEventListener("dragstart",this._onDragStart.bind(this)),this.editor.root.addEventListener("dragover",this._onDragOver.bind(this)),this.editor.root.addEventListener("dragleave",this._onDragLeave.bind(this)),this.editor.root.addEventListener("drop",this._onDrop.bind(this)),this.editor.root.addEventListener("dragend",this._onDragEnd.bind(this))}_onDragStart(t){if(this.editor.readOnly)return void t.preventDefault();const e=t.target,i=e?.closest(".image-block-wrapper, .video-block-wrapper");if(!i||!t.dataTransfer)return void t.preventDefault();this.draggingBlockEl=i,this.draggingBlockId=i.dataset.blockId??null,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",this.draggingBlockId??"");const o=i.cloneNode(!0);o.style.position="absolute",o.style.top="-9999px",o.style.width="120px",o.style.height="120px",o.style.objectFit="cover",o.style.overflow="hidden",document.body.appendChild(o),t.dataTransfer.setDragImage(o,t.offsetX,t.offsetY),setTimeout(()=>{i.classList.add("dragging"),o.remove()},0)}_onDragOver(t){if(t.preventDefault(),!this.draggingBlockEl)return;if(this._ensureDragIndicatorExists(),!this.dragIndicatorEl)return;this.dragIndicatorEl.style.display="none";const e=Array.from(this.editor.root.querySelectorAll(".block")).filter(t=>t!==this.draggingBlockEl);if(0===e.length)return;const i=this._calculateDropPosition(t.clientY,e);if(!i)return;const{targetBlock:o,dropPosition:s,indicatorTop:n}=i;this._updateDragIndicator(n),this.dragOverBlockEl=o,this.dropPosition=s}_onDragLeave(t){this.editor.root.contains(t.relatedTarget)||t.relatedTarget===this.editor.root||this._clearDragOverStyles()}_onDrop(t){if(t.preventDefault(),!this.draggingBlockId||!this.dragOverBlockEl||!this.dropPosition)return void this._onDragEnd();const e=this.editor.blocks,i=e.findIndex(t=>t.id===this.draggingBlockId),o=this.dragOverBlockEl.dataset.blockId,s=e.findIndex(t=>t.id===o);if(-1===i||-1===s||i===s)return void this._onDragEnd();let n=s;"bottom"===this.dropPosition&&(n+=1);const r=this._reorderBlocks(i,n);r?(this.editor.renderer.render(e),this.editor.saveHistory(),this.editor.selectAndFocusBlock(r),this._onDragEnd()):this._onDragEnd()}_onDragEnd(){this.draggingBlockEl&&this.draggingBlockEl.classList.remove("dragging"),this._clearDragOverStyles(),this.draggingBlockEl=null,this.draggingBlockId=null,this.dragOverBlockEl=null,this.dropPosition=null}_reorderBlocks(t,e){const i=this.editor.blocks,o=i.splice(t,1)[0];if(!o)return null;const s=e>t?e-1:e;return i.splice(s,0,o),o}_ensureDragIndicatorExists(){this.dragIndicatorEl&&this.dragIndicatorEl.parentNode!==this.editor.root&&(this.dragIndicatorEl=null),this.dragIndicatorEl||(this.dragIndicatorEl=document.createElement("div"),this.dragIndicatorEl.classList.add("drag-indicator"),this.editor.root.appendChild(this.dragIndicatorEl))}_calculateDropPosition(t,e){const i=this.editor.root.getBoundingClientRect();for(const[o,s]of e.entries()){const n=s.getBoundingClientRect();if(t<n.top+n.height/2)return{targetBlock:s,dropPosition:"top",indicatorTop:n.top-i.top};if(o===e.length-1)return{targetBlock:s,dropPosition:"bottom",indicatorTop:n.bottom-i.top}}return null}_updateDragIndicator(t){if(!this.dragIndicatorEl)return;const e=this.editor.root.getBoundingClientRect();this.dragIndicatorEl.style.top=`${t}px`,this.dragIndicatorEl.style.left="0px",this.dragIndicatorEl.style.width=`${e.width}px`,this.dragIndicatorEl.style.display="block"}_clearDragOverStyles(){this.dragIndicatorEl&&this.dragIndicatorEl.parentNode&&this.dragIndicatorEl.parentNode.removeChild(this.dragIndicatorEl),this.dragIndicatorEl=null}}class H extends g{constructor(t){super(t)}initialize(){this._bindExternalTools()}isImageOrVideoToolConfig(t,e){return"image"===t||"video"===t}_bindExternalTools(){Object.entries(this.editor.toolSettings).forEach(([t,e])=>{if(!e)return;const i=e.config;if(!this.isImageOrVideoToolConfig(t,i))return;if(!i.uploader||!i.uploader.fileSelectButton)return;const o=document.getElementById(i.uploader.fileSelectButton);o?o.addEventListener("click",e=>{this._handleToolButtonClick(e,t,i)}):console.warn(`Editor: External tool element #${i.uploader.fileSelectButton} for type "${t}" not found.`)})}async _handleToolButtonClick(t,e,i){if(t.preventDefault(),this.editor.checkBlockMaxCount(e))if(i.uploader.openFilePicker)try{await i.uploader.openFilePicker()}catch(t){console.error(`ExternalToolPlugin: Custom select for type "${e}" failed:`,t)}else i.uploader?.uploadByFile&&await this._handleFileUpload(e,i.uploader.uploadByFile)}async _handleFileUpload(t,e){const i=document.createElement("input");i.type="file",i.accept="video"===t?"video/*":"image/*",i.onchange=async i=>{const o=i.target,s=o?.files?.[0];if(s)try{const i=await e(s),o="string"==typeof i?i:i?.url??i?.file?.url??"";if(o){const e=this.editor.getToolConfig(t),i="video"===t?S.createDefault(o,{config:e?.config??{},api:{editor:this.editor,removeBlock:t=>this.editor.removeBlock(t)}}):m.createDefault(o,{config:e?.config??{},api:{editor:this.editor,removeBlock:t=>this.editor.removeBlock(t)}});this.editor.insertBlock(i)}}catch(e){console.error(`ExternalToolPlugin: ${t} upload failed:`,e)}},i.click()}}class P extends g{constructor(t){super(t),this.onMouseDownBound=this._onMouseDown.bind(this),this.onMouseMoveBound=this._onMouseMove.bind(this),this.onMouseUpBound=this._onMouseUp.bind(this),this.isDragging=!1,this.dragStartBlock=null}initialize(){this.editor.root.addEventListener("mousedown",this.onMouseDownBound),document.addEventListener("mousemove",this.onMouseMoveBound),document.addEventListener("mouseup",this.onMouseUpBound)}destroy(){this.editor.root.removeEventListener("mousedown",this.onMouseDownBound),document.removeEventListener("mousemove",this.onMouseMoveBound),document.removeEventListener("mouseup",this.onMouseUpBound)}_onMouseDown(t){const e=o(t.target);if(!e)return void(t.shiftKey||t.ctrlKey||t.metaKey||this.editor.multiSelection.clearSelection());const i=e.dataset.blockId;if(!i)return;const s=this.editor.blocks.find(t=>t.id===i);if(!s)return;const n=t.ctrlKey||t.metaKey;if(n&&!t.shiftKey)return t.preventDefault(),void this.editor.multiSelection.toggleBlockSelection(s);if(t.shiftKey&&!n){t.preventDefault();const e=this.editor.multiSelection.getSelectedBlocks();if(e.length>0&&e[0])this.editor.multiSelection.selectBlockRange(e[0],s);else{const t=this.editor.selection.getCurrentBlock()||this.editor.getSelectedBlock();t?this.editor.multiSelection.selectBlockRange(t,s):this.editor.multiSelection.selectBlock(s)}return}if(this.editor.multiSelection.hasSelection()){this.editor.multiSelection.getSelectedBlockIds().includes(s.id)||this.editor.multiSelection.clearSelection()}"text"!==s.type&&"list"!==s.type&&(this.isDragging=!0,this.dragStartBlock=s)}_onMouseMove(t){if(!this.isDragging||!this.dragStartBlock)return;const e=document.elementsFromPoint(t.clientX,t.clientY);for(const t of e){const e=o(t);if(e){const t=e.dataset.blockId;if(t){const e=this.editor.blocks.find(e=>e.id===t);e&&e!==this.dragStartBlock&&this.editor.multiSelection.selectBlockRange(this.dragStartBlock,e)}break}}}_onMouseUp(t){this.isDragging=!1,this.dragStartBlock=null}}class F extends g{constructor(t){super(t),this.el=null,this.mutationObserver=null,this.updateVisibilityBound=this.updatePlaceholderVisibility.bind(this),this.text=t.placeholderText||"내용을 입력하세요..."}initialize(){this.text&&(this.createPlaceholderElement(),this.observeEditorChanges(),this.updatePlaceholderVisibility())}createPlaceholderElement(){this.el=document.createElement("div"),this.el.className="editor-placeholder",this.el.textContent=this.text,this.editor.root.appendChild(this.el)}observeEditorChanges(){["input","keyup","mouseup","compositionend"].forEach(t=>{this.editor.root.addEventListener(t,this.updateVisibilityBound)}),this.mutationObserver=new MutationObserver(this.updateVisibilityBound),this.mutationObserver.observe(this.editor.root,{childList:!0,subtree:!0,characterData:!0}),this.editor.eventBus.on("block:removed",this.updateVisibilityBound),this.editor.eventBus.on("block:added",this.updateVisibilityBound)}updatePlaceholderVisibility(){const t=this.editor.blocks;if(1!==t.length)return void(this.el&&(this.el.style.display="none"));const e=t[0];if(!e)return;const i="text"===e.type&&"function"==typeof e.isEmpty&&e.isEmpty();this.el&&(this.el.style.display=i?"block":"none",i&&e.el&&this.positionPlaceholder(e.el))}positionPlaceholder(t){if(!this.el||!t)return;const e=t.getBoundingClientRect(),i=this.editor.root.getBoundingClientRect();this.el.style.top=e.top-i.top+"px",this.el.style.left=e.left-i.left+"px"}destroy(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null);["input","keyup","mouseup","compositionend"].forEach(t=>{this.editor.root.removeEventListener(t,this.updateVisibilityBound)}),this.editor.eventBus.off("block:removed",this.updateVisibilityBound),this.editor.eventBus.off("block:added",this.updateVisibilityBound),this.el?.remove(),this.el=null}}class z extends g{constructor(t){super(t),this.el=null,this.onSelectionChange=()=>{const t=window.getSelection();if(!t||t.isCollapsed)return void this.hideToolbar();if(!this.editor.root.contains(t.anchorNode)||!this.editor.root.contains(t.focusNode))return void this.hideToolbar();const e=t.getRangeAt(0).getBoundingClientRect();if(0===e.width&&0===e.height)return void this.hideToolbar();const i=this.editor.selection.getCurrentBlock();if(i){const t=this.editor.getToolConfig(i.type);if(!1===t?.toolbar)return void this.hideToolbar()}this.showToolbar(e)},this.onToolbarClick=t=>{const e=t.target.closest("button[data-cmd]");if(!(e instanceof HTMLElement))return;const i=e.dataset.cmd;if(i)try{document.execCommand(i,!1),this.editor.saveHistory()}catch(t){console.error(`ToolbarPlugin: command "${i}" failed`,t)}}}initialize(){document.addEventListener("selectionchange",function(t,e=100){let i=0,o=null;return function(...s){const n=this,r=Date.now();r-i>=e?(i=r,t.apply(n,s)):(null!==o&&clearTimeout(o),o=setTimeout(()=>{i=Date.now(),t.apply(n,s)},e-(r-i)))}}(this.onSelectionChange,50))}destroy(){document.removeEventListener("selectionchange",this.onSelectionChange),this.el?.remove()}createToolbarElement(){const t=document.createElement("div");return t.className="editor-toolbar hidden",t.innerHTML='\n            <button data-cmd="bold"><b>B</b></button>\n            <button data-cmd="italic"><i>I</i></button>\n            <button data-cmd="underline"><u>U</u></button>\n            <button data-cmd="strikeThrough"><s>S</s></button>\n        ',t.addEventListener("mousedown",t=>t.preventDefault()),t.addEventListener("click",this.onToolbarClick),t}showToolbar(t){this.el||(this.el=this.createToolbarElement(),document.body.appendChild(this.el));const e=this.el.getBoundingClientRect();this.el.style.left=t.left+t.width/2-e.width/2+"px",this.el.style.top=`${t.top-e.height-8+window.scrollY}px`,this.el.classList.remove("hidden")}hideToolbar(){this.el&&this.el.classList.add("hidden")}}class U{constructor(i){this.blockCountChangeCallbacks={},this.options=i;const{holder:o,toolbar:s=!0,placeholder:c="",tools:a={},plugins:d=[],readOnly:h=!1}=i;if(this.root="string"==typeof o?document.getElementById(o):o,!this.root)throw new Error("Editor: holder element not found!");this.toolbarEnabled=s,this.placeholderText=c,this.readOnly=h,this.toolSettings={},Object.assign(this.toolSettings,a),this.blocks=[],this.eventBus=new t,this.history=new e,this.selection=new n(this),this.multiSelection=new r(this),this.renderer=new l(this),this.plugins=[],this._initializePluginsAndToolSettings(d),this._mergeToolSettings(this.toolSettings,a),this._initializeBlockCountChangeCallbacks(),this.init(),this.eventBus.on("document:mutated",()=>{"function"==typeof this.options.onChange&&this.options.onChange(this.serialize())})}init(){this._setupRootElement(),this.blocks=[this.createDefaultBlock()],this.renderer.render(this.blocks),this.readOnly||(this.root.addEventListener("click",this.handleBlockClick.bind(this)),this.root.addEventListener("input",()=>{this.eventBus.emit("document:mutated")}),requestAnimationFrame(()=>{const t=this.blocks[0];t&&t.el&&this.selection.setRangeAtStart(t.el)})),this.saveHistory()}_setupRootElement(){this.root.classList.add("editor-root"),this.readOnly?(this.root.contentEditable="false",this.root.classList.add("editor-readonly")):this.root.contentEditable="true",this.root.setAttribute("spellcheck","false")}_initializeBlockCountChangeCallbacks(){Object.entries(this.toolSettings).forEach(([t,e])=>{e.onCountChange&&"function"==typeof e.onCountChange&&(this.blockCountChangeCallbacks[t]=e.onCountChange)})}_initializePluginsAndToolSettings(t){const e=[v];this.readOnly||e.push(D,I,M,N,H,P);const i=[k,x,B];this.toolbarEnabled&&!this.readOnly&&e.push(z),this.placeholderText&&!this.readOnly&&e.push(F);const o=[...e];i.forEach(t=>{if("function"==typeof t.getToolSettings){const e=t.getToolSettings(),i=Object.keys(e)[0];this.options.tools&&this.options.tools[i]&&o.push(t)}}),[...o,...t].forEach(t=>{if(t.prototype instanceof g){const e=new t(this);this.plugins.push(e),e.initialize(),"function"==typeof t.getToolSettings&&this._mergeToolSettings(this.toolSettings,t.getToolSettings())}else console.warn("Editor: Provided plugin does not extend base Plugin class.",t)})}getToolConfig(t){return this.toolSettings[t]}getImageUploader(){const t=this.getToolConfig("image")?.config;return t?.uploader??null}getVideoUploader(){const t=this.getToolConfig("video")?.config;return t?.uploader??null}_mergeToolSettings(t,e){Object.keys(e).forEach(t=>{this.toolSettings[t]={...this.toolSettings[t],...e[t],config:{...this.toolSettings[t]?.config??{},...e[t]?.config??{}}}})}createDefaultBlock(){return d("text","",{config:(this.toolSettings.text||{}).config??{},api:{removeBlock:t=>this.removeBlock(t),editor:this}})}insertBlock(t){if(!this.checkBlockMaxCount(t.type))return null;if(!this.isEditorEmpty()||"image"!==t.type&&"video"!==t.type){const e=this.selection.getCurrentBlock();e?this.addBlockAfter(e,t):this.blocks.push(t)}else this.blocks.splice(0,1,t);return this._notifyBlockCountChange(t.type),this._commitChange(),t}addBlockBefore(t,e){const i=this.blocks.indexOf(t);-1===i?this.blocks.unshift(e):this.blocks.splice(i,0,e),this.renderer.render(this.blocks),this.saveHistory()}addBlockAfter(t,e){const i=this.blocks.indexOf(t);-1===i?this.blocks.push(e):this.blocks.splice(i+1,0,e),this.renderer.render(this.blocks),this.saveHistory(),e.focus?.()}duplicateBlock(t){const e=t||this.getSelectedBlock()||this.selection.getCurrentBlock();if(!e)return null;if(!this.checkBlockMaxCount(e.type))return null;const i=e.toJSON(),o=this.toolSettings[i.type],s=h(i,{config:o?.config??{},api:{removeBlock:t=>this.removeBlock(t),editor:this}}),n=this.blocks.indexOf(e);return-1===n?this.blocks.push(s):this.blocks.splice(n+1,0,s),this._notifyBlockCountChange(s.type),this.renderer.render(this.blocks),this.saveHistory(),requestAnimationFrame(()=>{this.selectAndFocusBlock(s),"text"===s.type&&s.el&&this.selection.setRangeAtEnd(s.el)}),s}removeBlock(t){const e=t.type;this.blocks=this.blocks.filter(e=>e!==t),this.handleEmptyEditorState(),this._notifyBlockCountChange(e),this._commitChange()}handleEmptyEditorState(){if(0===this.blocks.length){const t=this.createDefaultBlock();this.blocks=[t],this.selectAndFocusBlock(t)}}getBlockCount(t){return this.blocks.filter(e=>e.type===t).length}checkBlockMaxCount(t){const e=this.getToolConfig(t);if(!e)return!1;const i=e.maxCount,o=this.getBlockCount(t);return!(void 0!==i&&o>=i)||(e.onMaxCountReached&&"function"==typeof e.onMaxCountReached&&e.onMaxCountReached(i),!1)}_notifyBlockCountChange(t){const e=this.getBlockCount(t),i=this.getToolConfig(t);if(!i)return;const o=i.maxCount;this.blockCountChangeCallbacks&&this.blockCountChangeCallbacks[t]&&this.blockCountChangeCallbacks[t](e,o)}getRemainingCount(t){const e=this.getToolConfig(t);if(!e)return 0;const i=e.maxCount;if(null==i)return 1/0;const o=this.getBlockCount(t);return Math.max(0,i-o)}canInsert(t){return this.getRemainingCount(t)>0}handleBlockClick(t){const e=t.target instanceof Element?t.target.closest(".block"):null;if(e instanceof HTMLElement){const i=e.dataset.blockId;if(i){const e=this.blocks.find(t=>t.id===i);e&&this.selectAndFocusBlock(e,t)}}else this._handleEmptySpaceClick(t)}_handleEmptySpaceClick(t){if(this.isEditorEmpty()&&this.blocks[0])return void this.selectAndFocusBlock(this.blocks[0],t);const e=this.blocks.filter(t=>"text"===t.type);if(e.length>0){const i=e[e.length-1];i&&(this.selectAndFocusBlock(i,t),i.el&&this.selection.setRangeAtEnd(i.el))}else this.blocks.length>0&&this.blocks[0]&&this.selectAndFocusBlock(this.blocks[0],t)}selectAndFocusBlock(t,e){if(!this.readOnly){if(this.blocks.forEach(e=>{e!==t&&e.el&&e.el.classList.remove("selected")}),t&&("image"===t.type||"video"===t.type)){const t=window.getSelection();t&&t.removeAllRanges()}t&&t.el&&(t.el.classList.add("selected"),t.focus(e))}}getSelectedBlock(){const t=this.root.querySelector(".block.selected");if(!t)return null;const e=t.dataset.blockId;return e&&this.blocks.find(t=>t.id===e)||null}saveHistory(){this.history.push(this.serialize())}undo(){if(!this.history.canUndo())return!1;const t=this.history.undo();return!!t&&(this._restoreState(t),!0)}redo(){if(!this.history.canRedo())return!1;const t=this.history.redo();return!!t&&(this._restoreState(t),!0)}_restoreState(t){this.blocks=t.map(t=>{const e=this.toolSettings[t.type];return h(t,{config:e?.config??{},api:{removeBlock:t=>this.removeBlock(t),editor:this}})}),this.renderer.render(this.blocks),requestAnimationFrame(()=>{this.blocks.length>0&&this.blocks[0]?.el&&(this.selectAndFocusBlock(this.blocks[0]),"text"===this.blocks[0].type&&this.selection.setRangeAtStart(this.blocks[0].el))});new Set(this.blocks.map(t=>t.type)).forEach(t=>this._notifyBlockCountChange(t)),this.eventBus.emit("document:mutated")}serialize(){return this.blocks.map(t=>t.toJSON())}load(t){this.blocks=t.map(t=>{const e=this.toolSettings[t.type];return h(t,{config:e?.config??{},api:{removeBlock:t=>this.removeBlock(t),editor:this}})}),this._commitChange({skipHistory:!0});new Set(this.blocks.map(t=>t.type)).forEach(t=>this._notifyBlockCountChange(t))}isEditorEmpty(){return 1===this.blocks.length&&null!=this.blocks[0]&&"text"===this.blocks[0].type&&this.blocks[0].isEmpty()}hasMeaningfulContent(){return this.serialize().some(t=>{switch(t.type){case"text":return(t.html??"").replace(/<br\s*\/?>/gi,"").trim().length>0;case"list":return(t.html??"").replace(/<br\s*\/?>/gi,"").trim().length>0;case"image":{const e=t?.src;return"string"==typeof e&&e.trim().length>0}case"video":{const e=t?.src;return"string"==typeof e&&e.trim().length>0}default:return!1}})}_commitChange(t){t?.skipHistory||this.saveHistory(),this.blocks.forEach(t=>{E(t)&&t.refreshListContent()}),this.renderer.render(this.blocks),t?.silent||this.eventBus.emit("document:mutated")}destroy(){this.eventBus.clear(),this.plugins.forEach(t=>{"function"==typeof t.destroy&&t.destroy()}),this.plugins=[],this.history.clear(),this.multiSelection.destroy(),this.blocks.forEach(t=>{"function"==typeof t.destroy&&t.destroy()}),this.blocks=[],this.root.innerHTML="",this.root.classList.remove("editor-root","editor-readonly"),this.root.removeAttribute("contenteditable"),this.root.removeAttribute("spellcheck"),this.blockCountChangeCallbacks={}}}export{f as BaseBlock,u as Blocks,U as Editor,m as ImageBlock,C as ListBlock,p as MediaBlock,w as TableBlock,y as TextBlock,b as TextEditableBlock,S as VideoBlock,U as default};
//# sourceMappingURL=editor.esm.js.map
